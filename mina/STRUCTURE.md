# MinaEscrowPool Restructuring Summary

This document outlines the restructuring of the MinaEscrowPool project into two separate packages:

- **escrowm-init**: Contract code and deployment tools
- **escrowm**: Settlement service for state management

---

## Final Structure

```
mina/
├── escrowm-init/                 # Contract & Deployment (Static)
│   ├── src/
│   │   ├── MinaEscrowPool.ts    # ✅ KEEP - Core contract
│   │   ├── utils.ts             # ✅ KEEP - UUID/Field helpers
│   │   ├── index.ts             # ✅ KEEP - Public exports
│   │   ├── MinaEscrowPool.test.ts  # ✅ KEEP - Contract tests
│   │   ├── settlement.test.ts   # ✅ KEEP - Settlement tests
│   │   ├── deploy-zeko.ts       # ✅ KEEP - Zeko deployment
│   │   ├── deploy-local.ts      # ✅ KEEP - Local deployment
│   │   │
│   │   ├── Add.ts               # ❌ REMOVE - Example file
│   │   ├── Add.test.ts          # ❌ REMOVE - Example test
│   │   ├── AddZkProgram.ts      # ❌ REMOVE - Example program
│   │   └── interact.ts          # ❌ REMOVE - Example interaction
│   │
│   ├── scripts/
│   │   ├── generate-keys.ts     # ✅ KEEP - Key generation
│   │   ├── generate-cache.ts    # ✅ KEEP - Cache generation
│   │   └── copy-cache-to-ui.ts  # ✅ KEEP - Cache utility
│   │
│   ├── __tests__/
│   │   └── MinaEscrowPool.slow.test.ts  # ✅ KEEP - Slow tests
│   │
│   ├── build/                   # ✅ KEEP - Compiled output
│   ├── cache/                   # ✅ KEEP - Proof cache
│   ├── package.json             # ✅ KEEP - Dependencies
│   ├── tsconfig.json            # ✅ KEEP - TS config
│   ├── DEPLOY_ZEKO.md          # ✅ KEEP - Deployment guide
│   ├── LICENSE                  # ✅ KEEP
│   └── .gitignore               # ✅ ADD if missing
│
└── escrowm/                      # Settlement Service (Active)
    ├── src/
    │   ├── index.ts             # ✅ NEW - Service entry point
    │   ├── config.ts            # ✅ NEW - Configuration
    │   ├── logger.ts            # ✅ NEW - Logging
    │   ├── mina-client.ts       # ✅ NEW - Mina client
    │   ├── settlement-worker.ts # ✅ NEW - Settlement logic
    │   └── contract-loader.ts   # ✅ NEW - Import from escrowm-init
    │
    ├── build/                   # Generated by tsc
    ├── package.json             # ✅ NEW - Service dependencies
    ├── tsconfig.json            # ✅ NEW - TS config
    ├── .env.example             # ✅ NEW - Environment template
    ├── .gitignore               # ✅ NEW
    └── README.md                # ✅ NEW - Service documentation
```

---

## What Was Created

### escrowm/ (Settlement Service)

**New Files**:

1. ✅ `src/index.ts` - Service entry point
2. ✅ `src/config.ts` - Configuration management
3. ✅ `src/logger.ts` - Logging utility
4. ✅ `src/mina-client.ts` - Simplified Mina client
5. ✅ `src/settlement-worker.ts` - Settlement proof logic
6. ✅ `src/contract-loader.ts` - Import contracts from escrowm-init
7. ✅ `package.json` - Service dependencies
8. ✅ `tsconfig.json` - TypeScript configuration
9. ✅ `.env.example` - Environment template
10. ✅ `.gitignore` - Git ignore rules
11. ✅ `README.md` - Comprehensive documentation

---

## How to Use

### Build Contracts (escrowm-init)

```bash
cd mina/escrowm-init
npm install
npm run build
```

This creates `build/src/index.js` with exports:

- `MinaEscrowPool`
- `offchainState`
- `TradeData`
- `TradeProof`
- `uuidToField`
- `isValidUUID`
- `getEscrowdPort`

### Deploy Contract (escrowm-init)

```bash
cd mina/escrowm-init

# Generate keys
npm run keys:generate

# Create .env
cat > .env << 'EOF'
DEPLOYER_KEY=EKE...
OPERATOR_KEY=EKE...
EOF

# Deploy to Zeko
npm run deploy:zeko
```

### Run Settlement Service (escrowm)

```bash
cd mina/escrowm
npm install
npm run build

# Create .env
cat > .env << 'EOF'
MINA_NETWORK=zeko-devnet
MINA_GRAPHQL_ENDPOINT=https://devnet.zeko.io/graphql
MINA_POOL_ADDRESS=B62qrb...
OPERATOR_PRIVATE_KEY=EKE...
SETTLEMENT_INTERVAL_MS=60000
SETTLEMENT_MIN_ACTIONS=1
LOG_LEVEL=info
EOF

# Start service
npm start
```

---

## Service Dependencies

### escrowm-init → (Nothing)

The contract package has no dependencies on other local packages. It's self-contained.

### escrowm → escrowm-init

The settlement service imports contracts from escrowm-init:

```typescript
// escrowm/src/contract-loader.ts
import {
  MinaEscrowPool,
  offchainState,
} from "../../escrowm-init/build/src/index.js";
```

**Build Order**:

1. Build `escrowm-init` first (creates contract exports)
2. Build `escrowm` second (imports from escrowm-init)

---

## Updated Total Services

After this restructuring:

### Local Services to Run

1. ✅ **Middleware** (Node.js)

   - API Server
   - Coordinator
   - Escrowd Manager

2. ✅ **Settlement Service** (Node.js) - NEW!

   - Settlement Worker
   - Proof Generation
   - State Management

3. ✅ **Zcashd** (Docker)

   - Full Zcash node

4. ✅ **Lightwalletd** (Docker, optional)
   - Shielded transactions

### Deployed Once

- ✅ **MinaEscrowPool** (zkApp on Zeko L2)

**Total: 4 services** (3-4 depending on shielded support)

---

## Benefits of This Structure

### 1. Separation of Concerns

- **escrowm-init**: Contract definition (static, deployed once)
- **escrowm**: Contract state management (dynamic, runs continuously)

### 2. Resource Isolation

Settlement proof generation:

- CPU-intensive (100% for 5-6 minutes)
- Memory-intensive (4-8GB)
- Doesn't block middleware API/coordinator

### 3. Independent Scaling

- Middleware: Scale for API traffic
- Settlement: Scale for CPU/memory

### 4. Clear Responsibilities

- **escrowm-init**: Developers working on contract logic
- **escrowm**: Ops team managing settlement service

### 5. Cleaner Imports

```typescript
// Middleware imports contract
import { MinaEscrowPool } from "../escrowm-init/build/src/index.js";

// Settlement service imports contract
import { MinaEscrowPool } from "../../escrowm-init/build/src/index.js";
```

No deployment scripts in imports!

---

## Migration Checklist

### escrowm-init Cleanup

- [ ] Remove `src/Add.ts`
- [ ] Remove `src/Add.test.ts`
- [ ] Remove `src/AddZkProgram.ts`
- [ ] Remove `src/interact.ts`
- [ ] Remove compiled examples from `build/`
- [ ] Verify `src/index.ts` exports all needed types
- [ ] Test build: `npm run build`
- [ ] Test deployment: `npm run deploy:local`

### escrowm Setup

- [x] Create all source files
- [x] Create `package.json`
- [x] Create `tsconfig.json`
- [x] Create `.env.example`
- [x] Create `.gitignore`
- [x] Create `README.md`
- [ ] Install dependencies: `npm install`
- [ ] Build: `npm run build`
- [ ] Test: `npm start`

### Middleware Integration

- [ ] Update middleware imports to use `escrowm-init/build/src/index.js`
- [ ] Remove settlement worker from middleware
- [ ] Update middleware README to mention separate settlement service
- [ ] Test middleware without settlement worker

---

## Production Deployment

### Docker Compose Example

```yaml
version: "3.8"

services:
  middleware:
    build: ./middleware
    ports:
      - "3000:3000"
    environment:
      - MINA_POOL_ADDRESS=${MINA_POOL_ADDRESS}
      - OPERATOR_PRIVATE_KEY=${OPERATOR_PRIVATE_KEY}
    restart: unless-stopped

  settlement:
    build: ./mina/escrowm
    environment:
      - MINA_POOL_ADDRESS=${MINA_POOL_ADDRESS}
      - OPERATOR_PRIVATE_KEY=${OPERATOR_PRIVATE_KEY}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 8G

  zcashd:
    image: electriccoinco/zcashd:latest
    ports:
      - "8232:8232"
    volumes:
      - zcash-data:/root/.zcash
    restart: unless-stopped

volumes:
  zcash-data:
```

### PM2 Ecosystem

```javascript
module.exports = {
  apps: [
    {
      name: "middleware",
      script: "build/src/index.js",
      cwd: "./middleware",
      instances: 1,
      autorestart: true,
      max_memory_restart: "1G",
    },
    {
      name: "settlement",
      script: "build/src/index.js",
      cwd: "./mina/escrowm",
      instances: 1,
      autorestart: true,
      max_memory_restart: "8G",
    },
  ],
};
```

---

## Testing the Setup

### 1. Build Contracts

```bash
cd mina/escrowm-init
npm install
npm run build
# Should create build/src/index.js with exports
```

### 2. Test Settlement Service

```bash
cd mina/escrowm
npm install
npm run build
# Create .env with proper config
npm start
# Should connect to network and start settlement worker
```

### 3. Trigger Settlement

Create pending actions by:

1. Running middleware coordinator (locks trades)
2. Wait for settlement service to detect pending actions
3. Observe 5-6 minute proof generation
4. See settlement transaction submitted

---

## Next Steps

1. **Clean up escrowm-init** - Remove example files
2. **Build and test escrowm** - Verify settlement service works
3. **Update middleware** - Remove settlement worker, update imports
4. **Create Dockerfile** - For escrowm service
5. **Update documentation** - Reflect new architecture

---

## Questions?

See:

- `escrowm-init/DEPLOY_ZEKO.md` - Deployment guide
- `escrowm/README.md` - Settlement service docs
- `middleware/README.md` - Middleware docs
- `MIDDLEWARE_ESCROWM_COMMUNICATION.md` - Communication architecture
